<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HDHomeRun DVR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-4">
    <h1 class="mb-4">HDHomeRun DVR</h1>

    <!-- Record Now Form -->
    <form id="recordForm" class="row g-3">
        <div class="col-md-4">
            <label for="channel" class="form-label">Channel</label>
            <select id="channel" name="channel" class="form-select">
                {% for ch in channels %}
                <option value="{{ ch }}">{{ ch }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label for="duration" class="form-label">Duration (min)</label>
            <input type="number" class="form-control" id="duration" name="duration" value="30">
        </div>

        <div class="col-md-2">
            <label for="format" class="form-label">Format</label>
            <select id="format" name="format" class="form-select">
                <option value="mp4" selected>MP4</option>
                <option value="ts">TS</option>
            </select>
        </div>

        <div class="col-md-2">
            <label for="crf" class="form-label">CRF</label>
            <input type="number" class="form-control" id="crf" name="crf" value="23">
        </div>

        <div class="col-md-2">
            <label for="preset" class="form-label">Preset</label>
            <select id="preset" name="preset" class="form-select">
                <option value="ultrafast">ultrafast</option>
                <option value="superfast">superfast</option>
                <option value="veryfast">veryfast</option>
                <option value="faster">faster</option>
                <option value="fast" selected>fast</option>
                <option value="medium">medium</option>
                <option value="slow">slow</option>
                <option value="slower">slower</option>
                <option value="veryslow">veryslow</option>
            </select>
        </div>

        <div class="col-md-12 mt-2">
            <button type="button" class="btn btn-primary me-2" onclick="startRecording()">Record Now</button>
            <button type="button" class="btn btn-danger" onclick="stopRecording()">Stop Recording</button>
        </div>
    </form>

    <hr>

    <!-- Scheduling -->
    <form id="scheduleForm" class="row g-3">
        <div class="col-md-2">
            <label class="form-label">Days</label><br>
            {% for day in days %}
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="days" value="{{ day }}" id="day{{ loop.index }}">
                    <label class="form-check-label" for="day{{ loop.index }}">{{ day }}</label>
                </div>
            {% endfor %}
        </div>

        <div class="col-md-2">
            <label for="time" class="form-label">Time (HH:MM)</label>
            <input type="time" class="form-control" id="time" name="time" value="20:00">
        </div>

        <div class="col-md-2 align-self-end">
            <button type="button" class="btn btn-success" onclick="scheduleRecording()">Schedule Recording</button>
        </div>
    </form>

    <hr>

    <!-- Progress -->
    <div id="progress" class="my-3"></div>

    <!-- Scheduled Recordings List -->
    <h4>Scheduled Recordings</h4>
    <ul id="scheduledList" class="list-group">
        {% for job in scheduled %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ job }}
            <button class="btn btn-sm btn-outline-danger" onclick="cancelScheduled('{{ loop.index0 }}')">Cancel</button>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
async function startRecording() {
    const data = {
        channel: document.getElementById("channel").value,
        duration: document.getElementById("duration").value,
        format: document.getElementById("format").value,
        crf: document.getElementById("crf").value,
        preset: document.getElementById("preset").value
    };
    const res = await fetch('/record_now', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
    const result = await res.json();
    document.getElementById("progress").innerText = result.message;
}

async function stopRecording() {
    const res = await fetch('/stop_recording', {method:'POST'});
    const result = await res.json();
    document.getElementById("progress").innerText = result.message;
}

async function scheduleRecording() {
    const days = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);
    const data = {
        channel: document.getElementById("channel").value,
        duration: document.getElementById("duration").value,
        format: document.getElementById("format").value,
        crf: document.getElementById("crf").value,
        preset: document.getElementById("preset").value,
        days: days,
        time: document.getElementById("time").value
    };
    const res = await fetch('/schedule', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
    const result = await res.json();
    document.getElementById("progress").innerText = result.message;
    window.location.reload();
}

async function cancelScheduled(idx) {
    const res = await fetch('/cancel', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({idx})});
    const result = await res.json();
    document.getElementById("progress").innerText = result.message;
    window.location.reload();
}
</script>
</body>
</html>
